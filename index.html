<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" 
          content="width=device-width, 
                   initial-scale=1.0">
    <title>PASTI - PAncam Suggested Target Interface</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
  <div id = "container">
    
    <div id="threejs-container">
      
        <div id="threejs-canvas"></div>
        
          <div id = 'ui-container'>
           <p id="solSelectLabel" style="font-size:3vh; position:absolute; bottom:-1vh; left:1vw; width:30vw; color: white">No Sol Selected</p>
           
    
<!-- Sidebar Toggle Buttons -->
      <button id = "openBtn1" class="btn btn-secondary position-fixed top-0 end-0 m-0" onclick="toggleSidebar(1)" >
                <
      </button>
      <button id = "openBtn2" class="btn btn-secondary position-fixed m-0" onclick="toggleSidebar(2)" >
        <
      </button>

<!-- Sidebar 1 control panel -->
    <div id="mySidebar1"
        class="border-start shadow position-fixed top-0 end-0 h-100 p-3 d-flex flex-column"
        style="width: 25vw; transform: translateX(100%); transition: transform 0.3s ease; z-index: 10001;">

      <!-- Header -->
      <div class="d-flex align-items-center mb-1 border-bottom pb-2" style="font-size:2.5vh;">
        <button class="closebtn btn"
                id="closeSidebarBtn"
                onclick="closeSidebar(1)"
                style="color:#ffffff; font-size:3vh; width: 3vw;">&times;</button>
        <h5 class="mb-0 fw-bold" style = 'font-size: 3vh;'>Control Panel</h5>
      </div>

      <!-- Main content area -->
      <div class="sidebar-content d-flex flex-column flex-grow-1 justify-content-around">

        <!-- Login / Logout -->
        <div class="container mb-2 pb-2 border-bottom">
          <div class="row g-2">
            <div class="col-6">
              <button id="login" class="btn btn-primary w-100" style="font-size:2vh; ">Login</button>
            </div>
            <div class="col-6">
              <button id="logout" class="btn btn-danger w-100" style="font-size:2vh;">Logout</button>
            </div>
          </div>
        </div>

        <!-- Day Selector -->
        <button id="openDaySelector" class="btn btn-outline-secondary w-100 mt-0" style="font-size:2vh;">Select Sol</button>
        <p id="solSelect" class="text-center mb-0" style="font-size:2vh;">No Sol Selected</p>

        <!-- Zoom Controls -->
        <div class="container mb-0 pt-2 border-top">
          <div class="row g-2">
            <div class="col-6">
              <button id = 'zoomIn' onclick="zoomIn()" class="btn btn-success w-100" style=" font-size:2vh;">Zoom In</button>
            </div>
            <div class="col-6">
              <button id = 'zoomOut' onclick="zoomOut()" class="btn btn-success w-100" style=" font-size:2vh;">Zoom Out</button>
            </div>
          </div>
        </div>

        <!-- View Controls -->
        <button id = 'resetView' onclick="resetView()" class="btn btn-warning w-100 ms-0" style=" font-size:2vh;">Reset View</button>

        <!-- Target Controls -->
        <div class="d-grid gap-1  w-100 ms-0 pt-1 border-top">
          <button id="targetClear" onclick="clearMarkers()" class="btn btn-outline-danger ms-4" style=" font-size:2vh;">Clear Suggestions</button>
          <button id="targetSend" class="btn btn-outline-primary ms-4" style=" font-size:2vh;">Send & Confirm Suggestions</button>
        </div>

        <!-- File Controls -->
        <div class="mb-0 pt-2 border-top">
          <button onclick="jsonDownload()" id="download" class="btn btn-info w-75 ms-4 mb-2" style=" font-size:2vh;">Download Local Suggestions</button>
          <label for="jsonFile" class="form-label" style="font-size:1.8vh;"><br></label>
          <input type="file" id="jsonFile" accept=".json" class="form-control form-control-sm mb-2" style="font-size:1.8vh;">
          <input type="button" id="upload" value="Submit Local Suggestions" onclick="jsonUpload()" class="btn btn-secondary w-75 ms-4" style=" font-size:2vh;"></label>
        </div>

        <!-- Checkboxes -->
        <div class="form-check mb-0 pt-2 border-top" style="font-size:1.8vh;">
          <input class="form-check-input" type="checkbox" id="scales" onclick="coordGrid()">
          <label class="form-check-label" for="scales">Coordinate Gridlines</label>
        </div>
        <div class="form-check mb-0 pb-0" style="font-size:1.8vh;">
          <input class="form-check-input" type="checkbox" id="markerShow" onclick="markerShow()" checked>
          <label class="form-check-label" for="markerShow">Show Suggestions</label>
        </div>

      </div>

      <!-- Footer / Instructions -->
      <div class="mt-auto pt-2 border-top" style="font-size:1.5vh;">
        <p class="mb-0">
          <strong>Controls:</strong><br>
          Double Left Click – Place Marker<br>
          Shift + Left Click – Draw Patch<br>
          Right Click – Pan<br>
          W: WAC FoV<br>
          H: HRC FoV<br>
          E: Enfys FoV
        </p>
      </div>

    </div>

<!-- Sidebar 2 current targets-->

<div id="mySidebar2" class="border-start shadow position-fixed top-0 end-0 h-100 p-3 d-flex flex-column" style="width:25vw; z-index:10001;transform: translateX(100%); transition: transform 0.3s ease; ">
  <!-- Header -->
  <div class="d-flex align-items-center mb-1 border-bottom pb-2" style="font-size:2.5vh;">
    <button class="closebtn btn" onclick="closeSidebar(2)" style="color:#fff; font-size:3vh; width:3vw;">&times;</button>
    <h5 class="mb-0 fw-bold" style="font-size:3vh;">Current Suggestions</h5>
  </div>

  <!-- Scrollable list -->
      <div class="sidebar-content flex-grow-1 d-flex flex-column" style="overflow-y:auto;">
        <div id="markerList" class="d-grid gap-1" 
            style="grid-template-columns: 1fr; max-height: calc(8 * 3rem); overflow-y:auto;">
            <!-- Items will go here -->

        </div>
      </div>
    </div>


    </div>

  </div>

</div>



      <div id="popupForm"  class="popup" style = 'display:none'>
        <div id="popupHeader" style="cursor: move; padding: 0.5rem; background-color: #eee; border-bottom: 1px solid #ccc;">
              Suggestion Form
         </div>

           <div class="popup-body" style="overflow-y: auto; max-height: calc(90vh - 3rem); padding: 1rem;">
        <form id="markerForm">
          <label>Suggestion Title: <input type="text" name="title" /></label><br />
          <label>Suggestion ID: <input type="text" name="suggestionID" disabled /></label><br />
          <label>User ID: <input type="text" name="userID" disabled /></label><br />
          <label>Suggestion Description:<br/><textarea name="description"></textarea></label><br />
          <label>Science Intent:<br/><textarea name="intent" ></textarea></label><br />

          <label>HRC:<input type="checkbox" name="HRC" /></label>
          <label>Enfys:<input type="checkbox" name="enfys" /></label><br />
          <label>WAC RGB:<input type="checkbox" name="wacRGB" /></label>
          <label>WAC Multispectral:<input type="checkbox" name="wacmulti" /></label><br />
          <label>Mosaic:<input type="checkbox" name="mosaic" /></label><br />

          <label>Keywords: 
            <select title = "Select Keywords"id="keyword_items"  style = 'height: 4vh'>
            <option value="nokw">Select Keywords</option>

            <option value="kw1">Keyword 1</option>
            <option value="kw2">Keyword 2</option>
            <option value="kw3">Keyword 3</option>
            </select>
        </label><br />
          <label><input type="text" name="selectedkeyywords" disabled /></label><br />

          <label>Other Notes:<br/><textarea name="notes"></textarea></label><br />

          <button type="submit" style = 'margin-bottom: 5px;'>Save</button>
          <button type="button" onclick="closePopup()">Cancel</button>
        </form>
      </div>


      
      <div id="tooltip" style="display:none; position:absolute; background:white; border:1px solid black; padding:5px; pointer-events:none; z-index:100; overflow-wrap: break-word; max-width:30vw"></div>
</div>        
<!-- Three.js core -->
<script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
<!-- OrbitControls -->
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- Gather Data -->
<script src="js_scripts2/Coords.js"></script>

<!-- Graphical Setup Script-->
<script src="js_scripts2/GraphicalSetup.js"></script>

<!-- Texture Loader Script-->
<script src="js_scripts2/TextureLoad.js"></script>

<!-- Marker Placing Script-->
<script src="js_scripts2/MarkerPlacement.js"></script>

<!-- PopupForm Script-->
<script src="js_scripts2/PopupForms.js"></script>

<!-- Key Press Script-->
<script src="js_scripts2/KeyPressFunctions.js"></script>

<!-- json Handler Script-->
<script src="js_scripts2/jsonHandler.js"></script>

<!-- Miscelleanous Functions Script-->
<script src="js_scripts2/MiscFunctions.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>





<script>
// Initial variables required before anything else can take place.
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const markers = [];
const meshes = [];
var w = innerWidth / 1.5, h = innerHeight / 1.5;
const rect = renderer.domElement.getBoundingClientRect();
//const markerColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
const markerColor = '#'+'40be9b'


const threejsContainer = document.getElementById('threejs-container');
threejsContainer.insertBefore(hud, threejsContainer.firstChild);
//const markerColor  = 0xffff00

function toggleSidebar(num) {
  const sidebar = document.getElementById(`mySidebar${num}`);
  const openbtn = document.getElementById(`openBtn${num}`);
  const isOpen = sidebar.style.transform === "translateX(0%)";

  openbtn.innerHTML = isOpen? '<':'>';
  sidebar.style.transform = isOpen ? "translateX(100%)" : "translateX(0%)";
  openbtn.style.transform = isOpen ? "translateX(0)" : "translateX(-25vw)";
}

function closeSidebar(num) {
  const sidebar = document.getElementById(`mySidebar${num}`);
  const openbtn = document.getElementById(`openBtn${num}`);
  sidebar.style.transform = 'translateX(100%)';
  openbtn.style.transform = 'translateX(0)'

  const isOpen = sidebar.style.transform === "translateX(100%)";
  openbtn.innerHTML = isOpen? '<':'>';

}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    updateCameraRulers();
    renderer.render(scene, camera);
  }

  const popup = document.getElementById("popupForm");
const header = document.getElementById("popupHeader");

let offsetX = 0, offsetY = 0;
let isDragging = false;
  header.addEventListener("mousedown", (e) => {
  isDragging = true;
  // Mouse position relative to popup top-left corner
  offsetX = e.clientX - popup.offsetLeft;
  offsetY = e.clientY - popup.offsetTop;
  document.body.style.userSelect = "none"; // prevent text selection while dragging
});

document.addEventListener("mouseup", () => {
  isDragging = false;
  document.body.style.userSelect = ""; // restore
});

document.addEventListener("mousemove", (e) => {
  if (!isDragging) return;
  // Calculate new position
  let left = e.clientX - offsetX;
  let top = e.clientY - offsetY;

  // Optional: constrain within viewport
  const maxLeft = window.innerWidth - popup.offsetWidth;
  const maxTop = window.innerHeight - popup.offsetHeight;
  left = Math.max(0, Math.min(left, maxLeft));
  top = Math.max(0, Math.min(top, maxTop));

  popup.style.left = left + "px";
  popup.style.top = top + "px";
});
  </script>

</body>
</html>
